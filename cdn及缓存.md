### cdn及浏览器缓存

一、为什么使用CDN或浏览器缓存、解决什么问题

    1 网络延迟
        浏览器获取资源是从网络环境中，所以会带来延迟。为了提高加载速度。


    2 减少数据传输体积
        不使用缓存，每次都会从服务器重新拉取js css img 等资源。造成重复下载大量资源


    3 说明：
        用户第一次请求网站，浏览器会从服务器一次性拉取所有资源。

        浏览器拿到资源后，会根据请求头缓存配置，判断是否将资源缓存到本地

        当第二次请求的时候，浏览器判断是否优先读取缓存


二、CDN或缓存介绍

    1 CDN介绍

        根据不同网络、不同地区用户，创建接近用户网络的边缘服务器，然后将文件缓存在这些边缘服务器（节点）上

        电信cdn 联通cdn 移动cdn 山东cdn 河北cdn


    2 策略
        根据不同cdn厂商配置不同


    3 缺点
        源服务器数据更新，cdn服务器数据未过期
        用户访问到的依旧是过期的缓存资源，这会导致用户最终访问出现偏差

        需要手动刷新缓存

        自动刷新：

            等文件在 CDN 节点的缓存过期之后，
            节点回源拉取源服务器上最新的文件。这个过程由 CDN 自动完成，无需手动操作





三、缓存--浏览器缓存
    
    1 策略

        Etag
            是一个哈希字符串
            服务器在响应中返回 Etag，浏览器在后续请求中携带此参数，如果服务器Etag和浏览器Etag一致，则304使用缓存

            使用范围：
                Expires 过期
                Cache-Control：no-cache 

                优先级较低




        Cache-Control

            public：所有内容都将被缓存(客户端、代理服务器-cdn)

            private：内容只缓存到客户端，不缓存到代理服务器

            no-cache：配合Etag使用

            no-store：所有内容不被缓存

            must-revalidation/proxy-revalidation：如果缓存内容失效，请求必须发送到服务器或代理服务器进行重新验证

            max-age=xx：缓存内容奖在xxx秒后失效

            例：
                Cache-Control: max-age=691200，可以在客户端存储 8 天



        Expires

            响应头标记数据的过期时间，超过后，缓存会被定义为过期

            Expires: Sat, 27 Apr 2019 11:43:15 GMT
            数据会在 2019 年 4 月 27 号的 11 点 43 分后过期

            ** Cache-Control 中有 max-age 指令，浏览器会忽略此参数


        Last-Modified
            服务器配置响应头此数据，告诉浏览器这条数据上次的修改时间的标签
            后续请求，浏览器携带此数据，和服务器做对比，判断是否更新数据

            根据最后修改时间判断是否使用缓存



    2 不足
         Expires 或者 Cache-Control 设置了 max-age 响应头的时候，

         浏览器不会向服务器发起校验请求，而是直接复用本地缓存。

         如果此时服务器进行了资源的更新，用户就无法获取到最新的资源，
         只能通过强制刷新浏览器缓存来跟服务器请求最新的资源




三、知识点

    1、状态码

        第一次访问网站，全部网络传输
        浏览器未关闭，重新打开站点，200，会优先从内存中读数据
        浏览器已关闭，打开站点，200，会优先从硬盘读取数据

        304状态和服务器有过http请求后，服务器告诉浏览器，资源未过期，可以继续使用缓存资源


    2、cdn请求过程

        访问 a.com
        200 cache(内存、硬盘)
        nginx 转发至 a.cdn.com，判断资源是否过期，
        过期：重新拉取源服务器数据，至cdn服务器  200ok
        未过期：返回304 读取本地缓存


    3、浏览器缓存优先级
        Cache-Control 中有 max-age
        Expires (因为max-age 会被忽略)
        Etag  (Cache-Control: no-cache)
<!-- https://www.jianshu.com/p/baf12d367fe7 -->












